plugins {
    id 'base'
    id 'com.palantir.docker' version '0.25.0'
    id 'com.palantir.docker-run' version '0.25.0'
    id 'pl.allegro.tech.build.axion-release' version '1.10.1'
}

project.version = scmVersion.version

docker {
    name "${project.name}:${project.version}"
    files "plugins.txt", "seedJob.xml"
}

Process process = "stat -f '%g' /var/run/docker.sock".execute() //if its running on linux, we have to use -c option instead, hardcoding it for now
def out = new ByteArrayOutputStream()
process.waitForProcessOutput(out, System.err)

String dockerSockGroupId = out.toString().trim()

println dockerSockGroupId
dockerRun {
    name "${project.name}"
    image "${project.name}:${project.version}"
    ports '8080:8080'
    clean false
    daemonize false
    arguments('-v', '/var/run/docker.sock:/var/run/docker.sock', '--group-add', 'root' ) //root is a workaround for now.. we should be able to use dockerSockGroupId
}
